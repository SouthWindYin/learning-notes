# 认证流程整理

## 核心概念的关系

* Filter中有一个AuthenticationManager
* AuthenticationManager中有一个AuthenticationProvider的List
* AuthenticationProvider持有UserDetailService
* UserDetailService使用AbstractAuthenticationToken来获取UserDetail
* Filter生成的AbstractAuthenticationToken，然后给AuthenticationManager使用
* AbstractAuthenticationToken是Authentication的子类
* Authentication持有UserDetails以及验证后的用户信息及权限
* 代码中可以使用SecurityContextHolder.getContext().getAuthentication()获取当前登录用户信息

## 默认流程分析：使用数据库验证用户

* UsernamePasswordAuthenticationFilter持有ProviderManager
* ProviderManager持有DaoAuthenticationProvider（AbstractUserDetailsAuthenticationProvider）（只有一个的list）
* DaoAuthenticationProvider持有JdbcUserDetailsManager（UserDetailService）
* UsernamePasswordAuthenticationFilter根据post请求的用户名密码生成UsernamePasswordAuthenticationToken，并将其传入ProviderManager的authenticate方法
* ProviderManager使用DaoAuthenticationProvider，根据UsernamePasswordAuthenticationToken生成UserDetails，填充Authentication，返回

## 业务场景：使用请求头中的字段验证用户

* RequestHeaderAuthenticationFilter持有ProviderManager
* ProviderManager持有PreAuthenticatedAuthenticationProvider
* PreAuthenticatedAuthenticationProvider持有JdbcUserDetailsManager
* RequestHeaderAuthenticationFilter根据请求头中的指定头生成PreAuthenticatedAuthenticationToken，并将其传入ProviderManager的authenticate方法
* ProviderManager使用PreAuthenticatedAuthenticationProvider，根据PreAuthenticatedAuthenticationToken使用JdbcUserDetailsManager的生成UserDetails，填充Authentication，返回
