# redis问答

## 什么是延迟双删

对于读取数据，流程始终不变：  

``` uml
读取redis->读取数据库->更新redis
```  

更新数据则有多种设计方法：

``` uml
1. 修改数据库->更新redis
2. 修改数据库->删除redis
3. 修改数据库->删除redis->延迟3-5s再删除redis
```

采取1时，单线程下没问题，同时有两个修改请求时可能发生

``` uml
1修改数据库->2修改数据库->2更新redis->1更新redis
```

所以可能出现最终更新到redis中是脏数据的情况。此时我们可以选择把更新数据的第二步改为删除redis，这样两个修改请求不会因为删除redis顺序不一样产生脏数据。

采取2时，如果此时有两个修改请求，还有一个查询请求，则可能发生

``` uml
1修改数据库->1删除redis->查询redis->查询数据库->2修改数据库->2删除redis->更新redis（查询请求）
```

从而更新了脏数据进redis。  
解决办法是采取3，延迟一定时间再删除一次redis，则可以保证删除redis是比更新redis更后面的操作，避免更新脏数据进redis。

## redis事务

redis事务实际上就是用MULTI命令和EXEC命令包起来连续执行的一系列redis命令。redis事务的原子性有一些特殊，如果事务中的命令有语法错误，则整个事务会失败，回到事务开始前的状态；但是如果只发生了运行错误，则除开运行错误的命令外的其他命令会成功执行。redis事务不支持回滚，官方表示需要回滚是因为编程过程中的错误，应当在编程过程中避免，而且没有回滚redis更快。

## redis事务和pipeline的区别

pipeline是一连串的一起提交的redis命令，是客户端行为，redis服务器是感觉不到区别的。而redis事务是redis服务器上的原子操作（特殊的原子）。

## redis如何清理过期key

1. 被动清理：客户端访问过期key时，redis将其从内存中删除。
2. 主动清理：随机抽取100（该值可调）个过期的key将其从内存中删除。

主动清理的时机：当redis中过期key的比例超过了25%（该值可调），则会执行主动清理，如果清理之后比例依然大于25%，则再主动清理一次。当redis内存不足时也会执行主动清理。